name: Deploy main branch as website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. SETUP LOGGING (Create a temporary folder outside dist to save logs safely)
      - name: Create Temp Log Directory
        run: mkdir -p temp_logs

      # 2. INSTALL (Run in subfolder, save log to temp_logs)
      - name: Install Dependencies
        id: install
        run: |
          cd Frontend
          # We pipe output to a log file outside the build folder so it survives
          npm install |& tee ../temp_logs/install.log

      # 3. BUILD (Run in subfolder, save log to temp_logs)
      # This deletes 'dist', which is why we waited to create the dashboard files!
      - id: compute-base
        name: Compute base path
        run: |
          repo="${GITHUB_REPOSITORY#*/}"
          echo "base=/$repo/" >> $GITHUB_OUTPUT

      - name: Build the project
        id: build
        run: |
          cd Frontend
          npm run build -- --base "${{ steps.compute-base.outputs.base }}" |& tee ../temp_logs/build.log

      # 4. RUN OPTIONAL CHECKS (Lint/Test)
      # Added "|| true" so the build doesn't fail if you don't have these scripts yet
      - name: Run Linter
        id: lint
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          npm run lint |& tee ../temp_logs/lint.log || echo "Lint script missing or failed" >> ../temp_logs/lint.log

      - name: Run Tests
        id: test
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          npm test |& tee ../temp_logs/test.log || echo "Test script missing or failed" >> ../temp_logs/test.log

      # 5. GENERATE DASHBOARD (Now that dist exists and is stable)
      - name: Generate Dashboard and Logs
        if: ${{ !cancelled() }}
        run: |
          # Define paths
          DIST="Frontend/dist"
          DOCS="Frontend/docs"
          
          # Create necessary directories if they don't exist
          mkdir -p $DIST
          mkdir -p $DOCS

          # --- Create HTML Logs from the temp files we saved ---
          
          # Installation Log
          echo "<html><body><pre>" > $DIST/installation.html
          cat temp_logs/install.log >> $DIST/installation.html
          echo "</pre></body></html>" >> $DIST/installation.html
          
          # Build Log
          echo "<html><body><pre>" > $DIST/build.html
          cat temp_logs/build.log >> $DIST/build.html
          echo "</pre></body></html>" >> $DIST/build.html

          # Lint Log
          echo "<html><body><pre>" > $DIST/lint.html
          if [ -f temp_logs/lint.log ]; then cat temp_logs/lint.log >> $DIST/lint.html; fi
          echo "</pre></body></html>" >> $DIST/lint.html

          # Test Log
          echo "<html><body><pre>" > $DIST/tests.html
          if [ -f temp_logs/test.log ]; then cat temp_logs/test.log >> $DIST/tests.html; fi
          echo "</pre></body></html>" >> $DIST/tests.html

          # --- Create Dashboard Markdown ---
          printf '## Quick Links\n\n' > $DOCS/dashboard.md
          echo "* [Deployed Site](../): Your actual website." >> $DOCS/dashboard.md
          echo "* [Installation Log](../installation.html)" >> $DOCS/dashboard.md
          echo "* [Build Log](../build.html)" >> $DOCS/dashboard.md
          echo "* [Linter Log](../lint.html)" >> $DOCS/dashboard.md
          echo "* [Test Log](../tests.html)" >> $DOCS/dashboard.md

          # Create Redirects
          echo "<html><head><meta http-equiv='refresh' content='0; URL=docs/dashboard' /></head><body>Redirecting...</body></html>" > $DIST/dashboard.html
          cp $DIST/dashboard.html $DIST/quick.html

      # 6. DOCS GENERATION
      - name: Generate HTML from Markdown
        if: ${{ !cancelled() }}
        uses: ldeluigi/markdown-docs@latest
        with:
          src: Frontend/docs
          dst: Frontend/dist/docs/

      # 7. UPLOAD & DEPLOY
      - name: Setup Pages
        if: ${{ !cancelled() }}
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: ${{ !cancelled() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: "Frontend/dist/"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
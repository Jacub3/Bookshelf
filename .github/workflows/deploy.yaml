name: Deploy main branch as website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    # This ensures that if a pipe (|) fails, the whole step fails
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      # 1. SETUP LOGGING
      - name: Create Temp Log Directory
        run: mkdir -p temp_logs

      # 2. INSTALL
      - name: Install Dependencies
        id: install
        run: |
          set -o pipefail
          cd Frontend
          npm install | tee ../temp_logs/install.log

      # 3. BUILD
      # We removed the manual base argument. We now trust your vite.config.js
      - name: Build the project
        id: build
        run: |
          set -o pipefail
          cd Frontend
          # If this step fails, the workflow will now correctly STOP and turn Red.
          npm run build | tee ../temp_logs/build.log

      # 4. RUN CHECKS
      - name: Run Linter
        id: lint
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          # We allow this to "pass" with || true so we can see the logs even if lint fails
          npm run lint > ../temp_logs/lint.log 2>&1 || true

      - name: Run Tests
        id: test
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          npm test > ../temp_logs/test.log 2>&1 || true

      # 5. PREPARE DASHBOARD ASSETS
      - name: Generate Log HTML and Dashboard MD
        if: ${{ !cancelled() }}
        run: |
          DIST="Frontend/dist"
          DOCS="Frontend/docs"
          
          # Ensure dist exists (in case build failed but we are forcing a run)
          mkdir -p $DIST
          mkdir -p $DOCS

          # --- Create HTML Wrappers for Logs ---
          for log in install build lint test; do
            echo "<html><body><pre>" > $DIST/${log}.html
            if [ -f temp_logs/${log}.log ]; then 
              cat temp_logs/${log}.log >> $DIST/${log}.html
            else
              echo "No log found." >> $DIST/${log}.html
            fi
            echo "</pre></body></html>" >> $DIST/${log}.html
          done

          # --- Create Dashboard Markdown ---
          # We use relative path '.' which works great with vite base: './'
          printf '## Quick Links\n\n' > $DOCS/dashboard.md
          echo "* [Deployed Site](../): Your actual website." >> $DOCS/dashboard.md
          echo "* [Installation Log](../install.html)" >> $DOCS/dashboard.md
          echo "* [Build Log](../build.html)" >> $DOCS/dashboard.md
          echo "* [Linter Log](../lint.html)" >> $DOCS/dashboard.md
          echo "* [Test Log](../test.html)" >> $DOCS/dashboard.md

      # 6. DOCS GENERATION
      - name: Generate HTML from Markdown
        if: ${{ !cancelled() }}
        uses: ldeluigi/markdown-docs@latest
        with:
          src: Frontend/docs
          dst: Frontend/dist/docs/

      # 7. DEBUG & CHECK
      - name: Debug Output Directory
        if: ${{ !cancelled() }}
        run: |
          echo "Listing 'Frontend/dist' contents to verify build:"
          ls -R Frontend/dist || echo "Dist folder missing!"

      # 8. UPLOAD & DEPLOY
      - name: Setup Pages
        if: ${{ !cancelled() }}
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: ${{ !cancelled() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: "Frontend/dist/"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

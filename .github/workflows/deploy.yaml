name: Deploy main branch as website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # Cache dependencies to speed up future runs
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      # 1. SETUP LOGGING
      - name: Create Temp Log Directory
        run: mkdir -p temp_logs

      # 2. INSTALL
      - name: Install Dependencies
        id: install
        run: |
          cd Frontend
          npm install |& tee ../temp_logs/install.log

      # 3. BUILD
      - id: compute-base
        name: Compute base path
        run: |
          repo="${GITHUB_REPOSITORY#*/}"
          echo "base=/$repo/" >> $GITHUB_OUTPUT

      - name: Build the project
        id: build
        run: |
          cd Frontend
          npm run build -- --base "${{ steps.compute-base.outputs.base }}" |& tee ../temp_logs/build.log

      # 4. RUN CHECKS (Lint/Test)
      - name: Run Linter
        id: lint
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          # '|| echo' ensures the build continues even if lint fails, so you can see the log in the dashboard
          npm run lint |& tee ../temp_logs/lint.log || echo "Lint script missing or failed" >> ../temp_logs/lint.log

      - name: Run Tests
        id: test
        if: ${{ !cancelled() }}
        run: |
          cd Frontend
          npm test |& tee ../temp_logs/test.log || echo "Test script missing or failed" >> ../temp_logs/test.log

      # 5. PREPARE DASHBOARD ASSETS
      - name: Generate Log HTML and Dashboard MD
        if: ${{ !cancelled() }}
        run: |
          DIST="Frontend/dist"
          DOCS="Frontend/docs"
          
          mkdir -p $DIST
          mkdir -p $DOCS

          # --- Create HTML Wrappers for Logs ---
          for log in install build lint test; do
            echo "<html><body><pre>" > $DIST/${log}.html
            if [ -f temp_logs/${log}.log ]; then 
              cat temp_logs/${log}.log >> $DIST/${log}.html
            else
              echo "No log found." >> $DIST/${log}.html
            fi
            echo "</pre></body></html>" >> $DIST/${log}.html
          done

          # --- Create Dashboard Markdown ---
          # This Markdown file will be converted to HTML in the next step
          printf '## Quick Links\n\n' > $DOCS/dashboard.md
          echo "* [Deployed Site](../): Your actual website." >> $DOCS/dashboard.md
          echo "* [Installation Log](../install.html)" >> $DOCS/dashboard.md
          echo "* [Build Log](../build.html)" >> $DOCS/dashboard.md
          echo "* [Linter Log](../lint.html)" >> $DOCS/dashboard.md
          echo "* [Test Log](../test.html)" >> $DOCS/dashboard.md

          # NOTE: We removed the overwrite of index.html here so your actual site remains accessible.

      # 6. DOCS GENERATION (Markdown -> HTML)
      # This step creates the actual dashboard.html file
      - name: Generate HTML from Markdown
        if: ${{ !cancelled() }}
        uses: ldeluigi/markdown-docs@latest
        with:
          src: Frontend/docs
          dst: Frontend/dist/docs/

      # 7. POST-PROCESSING (NEW STEP)
      # Now that dashboard.html exists, we can move/copy it safely
      - name: Finalize Dashboard Links
        if: ${{ !cancelled() }}
        run: |
          # Copy the dashboard to a root file for easy access (e.g., /dashboard.html)
          if [ -f Frontend/dist/docs/dashboard.html ]; then
             cp Frontend/dist/docs/dashboard.html Frontend/dist/quick.html
          fi

      # 8. UPLOAD & DEPLOY
      - name: Setup Pages
        if: ${{ !cancelled() }}
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: ${{ !cancelled() }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: "Frontend/dist/"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
